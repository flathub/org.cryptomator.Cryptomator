app-id: org.cryptomator.Cryptomator
command: cryptomator
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
separate-locales: false
finish-args:
  # OpenGL rendering
  - --device=dri
  # Set the PATH environment variable in the application, as flatpak is resetting the shell's PATH
  - --env=PATH=/app/bin/:/usr/bin/
  # Allow filesystem access to the user's home dir
  # Needed to manage vaults there
  - --filesystem=home
  # Allow access to the XDG data directory
  # Needed to connect to KeePassXC's UNIX domain socket
  - --filesystem=xdg-run/org.keepassxc.KeePassXC.BrowserServer
  - --filesystem=xdg-run/app/org.keepassxc.KeePassXC/
  # Share IPC namespace with the host, without it the X11 shared memory extension will not work
  - --share=ipc
  # Allow access to the network
  - --share=network
  # Show windows using X11
  - --socket=x11
  # Needed to reveal encrypted files
  - --talk-name=org.freedesktop.FileManager1
  # Run any command on the host
  # Needed to spawn fusermount on the host
  - --talk-name=org.freedesktop.Flatpak
  # Allow desktop notifications
  - --talk-name=org.freedesktop.Notifications
  # Allow access to the GNOME secret service API and to talk to the GNOME keyring daemon
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.gnome.keyring
  # Allow to talk to the KDE kwallet daemon
  - --talk-name=org.kde.kwalletd5
  # Needed to talk to the gvfs daemons over D-Bus and list mounts using the GIO APIs
  - --talk-name=org.gtk.vfs.*
cleanup:
  - /include
  - /lib/pkgconfig
modules:
  - name: libfuse
    buildsystem: meson
    config-opts:
      - -Dexamples=false
      - -Duseroot=false
      - -Dtests=false
      # don't install rules on the host
      - -Dudevrulesdir=/tmp/
    sources:
      - type: archive
        url: https://github.com/libfuse/libfuse/releases/download/fuse-3.14.0/fuse-3.14.0.tar.xz
        sha256: 96115b2a8ff34bd1e0c7b00c5dfd8297571d7e165042b94498c9a26356a9a70a
        x-checker-data:
          type: anitya
          project-id: 861
          url-template: https://github.com/libfuse/libfuse/releases/download/fuse-$version/fuse-$version.tar.xz
          versions: {<: '4.0'}
  - name: host-command-wrapper
    buildsystem: simple
    build-commands:
      - install fusermount-wrapper.sh /app/bin/fusermount3
    sources:
      - type: file
        path: build-aux/fusermount-wrapper.sh
  - name: cryptomator
    buildsystem: simple
    build-options:
      env:
        PATH: /app/bin:/usr/bin
        MAVEN_OPTS: -Dmaven.repo.local=.m2/repository
        JAVA_HOME: jdk
        JMODS_PATH: jmods:${JAVA_HOME}/jmods
        VERSION: 1.7.0
        REVISION_NO: '1'
    build-commands:
      # Setup Java
      - tar xvfz jdk.tar.gz --transform 's!^[^/]*!jdk!'
      - mkdir jmods
      - unzip -j openjfx.zip \*/javafx.base.jmod \*/javafx.controls.jmod \*/javafx.fxml.jmod
        \*/javafx.graphics.jmod -d jmods
      # Setup Maven
      - mkdir maven
      - tar xf maven.tar.gz --strip-components=1 --exclude=jansi-native --directory=maven
      # Build project
      - maven/bin/mvn clean package -DskipTests -Plinux
      - cp dist/linux/launcher* target
      - cp target/cryptomator-*.jar target/mods
      - cd target
      - $JAVA_HOME/bin/jlink --output runtime --module-path $JMODS_PATH --add-modules
        java.base,java.desktop,java.instrument,java.logging,java.naming,java.net.http,java.scripting,java.sql,java.xml,javafx.base,javafx.graphics,javafx.controls,javafx.fxml,jdk.unsupported,jdk.crypto.ec,jdk.security.auth,jdk.accessibility,jdk.management.jfr
        --no-header-files --no-man-pages --strip-debug --compress=1
      - $JAVA_HOME/bin/jpackage --type app-image --runtime-image runtime --input target/libs
        --module-path target/mods --module org.cryptomator.desktop/org.cryptomator.launcher.Cryptomator
        --dest . --name Cryptomator --vendor 'Skymatic GmbH' --java-options '--enable-preview'
        --java-options '--enable-native-access=org.cryptomator.jfuse.linux.amd64,org.cryptomator.jfuse.linux.aarch64'
        --copyright '(C) 2016 - 2023 Skymatic GmbH' --java-options '-Xss5m' --java-options
        '-Xmx256m' --java-options '-Dfile.encoding='utf-8'' --java-options '-Dcryptomator.logDir='~/.local/share/Cryptomator/logs''
        --java-options '-Dcryptomator.settingsPath='~/.config/Cryptomator/settings.json:~/.Cryptomator/settings.json''
        --java-options '-Dcryptomator.p12Path='~/.config/Cryptomator/key.p12'' --java-options
        '-Dcryptomator.ipcSocketPath='~/.config/Cryptomator/ipc.socket'' --java-options
        '-Dcryptomator.mountPointsDir='~/.local/share/Cryptomator/mnt'' --java-options
        '-Dcryptomator.pluginDir='~/.local/share/Cryptomator/plugins'' --java-options
        '-Dcryptomator.showTrayIcon=false' --java-options "-Dcryptomator.buildNumber='flatpak-${REVISION_NO}'"
        --java-options "-Dcryptomator.appVersion='${VERSION}'" --app-version "${VERSION}.${REVISION_NO}"
        --verbose
      - cp -R Cryptomator /app/
      - ln -s /app/Cryptomator/bin/Cryptomator /app/bin/cryptomator
      - install -D -m0644 -t /app/share/applications/ dist/linux/common/org.cryptomator.Cryptomator.desktop
      - install -D -m0644 -t /app/share/icons/hicolor/scalable/apps/ dist/linux/common/org.cryptomator.Cryptomator.svg
      - install -D -m0644 -t /app/share/metainfo/ dist/linux/common/org.cryptomator.Cryptomator.metainfo.xml
    sources:
      - maven-dependencies.yaml
      - maven-dependencies-x86_64.yaml
      - maven-dependencies-aarch64.yaml
      - type: archive
        sha512: e93b5c83a841014ecc500c929b94c09bb2ab6c698c643c90bfeb1dd52e9d816c4da07965743f2a7edae367442a5bf0f319e4c647d284c307c0f36e6067a7673c
        url: https://github.com/cryptomator/cryptomator/archive/refs/tags/1.7.0.tar.gz
      - type: file
        only-arches:
          - x86_64
        url: https://github.com/adoptium/temurin19-binaries/releases/download/jdk-19.0.2%2B7/OpenJDK19U-jdk_x64_linux_hotspot_19.0.2_7.tar.gz
        sha512: bc04881cd3b999ede7dd4f3d580518b99990885cb57a165e807e32837b18cc7b4fd3a9320376222507f085b5f4fe88fd69d2b26dd4f8f34c890f000e6b316880
        dest-filename: jdk.tar.gz
      - type: file
        only-arches:
          - aarch64
        url: https://github.com/adoptium/temurin19-binaries/releases/download/jdk-19.0.2%2B7/OpenJDK19U-jdk_aarch64_linux_hotspot_19.0.2_7.tar.gz
        sha512: 2198e2440c40c3517eab680dce34743c26f52629cb3cffc2f5a2b0a8813d637bb3e683a3ca4bc8e30f69579b7ec2bf0bf06f26f1e3e60e0764e464719013cdd5
        dest-filename: jdk.tar.gz
      - type: file
        only-arches:
          - x86_64
        url: https://download2.gluonhq.com/openjfx/19.0.2.1/openjfx-19.0.2.1_linux-x64_bin-jmods.zip
        sha512: 83a70834aec3b894abb1d68f0e9ddc255f266d48392cdb5c4712514d81bf5450d89c7a36c4a5abce87082a54efda8f8d1874872ee064a18398ddb3a9337c5cd9
        dest-filename: openjfx.zip
      - type: file
        only-arches:
          - aarch64
        url: https://download2.gluonhq.com/openjfx/19.0.2.1/openjfx-19.0.2.1_linux-aarch64_bin-jmods.zip
        sha512: dfe97808504103ce7512ce79583088fb8be65280f9336780c40a2f4063bab72b32601059180bd0110324d7f565c640705b65fbbada26cb57648ae56589696288
        dest-filename: openjfx.zip
      - type: file
        url: http://archive.apache.org/dist/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz
        sha512: f790857f3b1f90ae8d16281f902c689e4f136ebe584aba45e4b1fa66c80cba826d3e0e52fdd04ed44b4c66f6d3fe3584a057c26dfcac544a60b301e6d0f91c26
        dest-filename: maven.tar.gz
